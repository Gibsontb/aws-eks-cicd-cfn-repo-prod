# ============================================================
# Author: TGibson
# File: templates/velero-backup-bucket.yaml
# Repo: AWS EKS CI/CD (Commercial + GovCloud) via CloudFormation
# Version: 1.1
# Date: 2025-08-27
# ============================================================
AWSTemplateFormatVersion: '2010-09-09'
Description: S3 bucket + KMS key for Velero backups (Created 2025-08-28)
Parameters:
  BucketName:
    Type: String
  KmsAlias:
    Type: String
    Default: alias/velero-backups
Resources:
  Key:
    Type: AWS::KMS::Key
    Properties:
      EnableKeyRotation: true
      KeyPolicy:
        Version: "2012-10-17"
        Statement:
          - Sid: Allow account use
            Effect: Allow
            Principal:
              AWS: !Sub arn:aws:iam::{AWS::AccountId}:root
            Action: "kms:*"
            Resource: "*"
  Alias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Ref KmsAlias
      TargetKeyId: !Ref Key
  Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref BucketName
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref Key
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
  BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref Bucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: EnforceTLS
            Effect: Deny
            Principal: "*"
            Action: "s3:*"
            Resource:
              - !Sub arn:aws:s3:::{Bucket}
              - !Sub arn:aws:s3:::{Bucket}/*
            Condition:
              Bool:
                aws:SecureTransport: false
Outputs:
  BucketName:
    Value: !Ref Bucket
  KmsKeyArn:
    Value: !GetAtt Key.Arn
